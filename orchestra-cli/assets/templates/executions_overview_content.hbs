{{!--
The executions overview page allows to see all the executions, to sort filter and manipulate those.
--}}


{{!-- Title and help box --}}
<div class="ui accordion" style="padding-top: 2%">
    <div class="title">
        <h1>Executions<i class="dropdown icon"></i></h1>
    </div>
    <div class="content">
        <div class="ui info message transition">
            <div class="header">
                What to do here?
            </div>
            <p>You can see an overview of the different executions. To select an execution, just click on it.
            The search range is effective on all columns.</p>
        </div>
    </div>
    <br>
</div>
<script>
    $(".ui.accordion").accordion();
</script>


<!-- Executions table -->
<div class="ui centered grid" , id="grid">
    <div class="sixteen wide column">
        <table class="ui compact table" id='executions_table'>
            <thead>
            <tr>
                <th>Id</th>
                <th>Commit</th>
                <th>Params.</th>
                <th>Status</th>
                <th>Date</th>
                <th>Duration</th>
                <th>Profile</th>
                <th>Generator</th>
                <th>Code</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script>
        $("#executions_table").DataTable({
            "paging": false,
            "ajax": "/api/get_executions",
            "columnDefs": [
                {
                    "render": function (data, type, row) {
                        return `<a href="/executions/${data}" id="${data}">${data.slice(0, 9) + "..."}</a>`;
                    },
                    "targets": 0,
                },
                {
                    "render": function (data, type, row) {
                        return data.slice(0, 5);
                    },
                    "targets": 1,
                },
                {
                    "render": function(data, type, row) {
                        console.log(data);
                        re = /([[0-9\-*]*)T([^\.]*)/g;
                        match = re.exec(data);
                        if (match === null){
                            return ""
                        }
                        else{
                            return match[1] + " " + match[2];
                        }
                    },
                    "targets": 4,
                }
            ],
            "createdRow": function (row, data, dataIndex) {
                if (data[8] == "0") {
                    $(row).addClass("positive");
                }
                else {
                    $(row).addClass("negative");
                }
            },
            "dom": '<"ui buttons"> frti',
        });
        $("div.ui.buttons").html(`
            <button class="ui basic primary button" id="executions_table_select_all_button">
                Select All
            </button>
            <button class="ui basic primary button" id="executions_table_deselect_all_button">
                Deselect All
            </button>
            <div class="ui basic yellow dropdown button" id="executions_table_reschedule_button">
                <i class="recycle icon"></i>
                <span class="text">Reschedule</span>
                <div class="menu">
                </div>
            </div>
            <button class="ui basic negative button" id="executions_table_delete_button">
                <i class="trash alternate outline icon"></i>
                Delete
            </button>
        `);
        $("#executions_table_filter").css("float", "right");
        $("#executions_table tbody").on("click", "tr", function () {
            $(this).toggleClass("active");
        });
        $("#executions_table_select_all_button").click(function () {
            $("#executions_table").DataTable().rows({"search": "applied",}).nodes().toArray().forEach(x => $(x).addClass("active"));
        });
        $("#executions_table_deselect_all_button").click(function () {
            $("#executions_table").DataTable().rows({"search": "applied",}).nodes().toArray().forEach(x => $(x).removeClass("active"));
        });
        $("#executions_table_delete_button").click(function () {
            $("#executions_table_delete_button").addClass("loading");
            let identifiers = $("#executions_table").DataTable()
                    .rows({"search": "applied",})
                    .nodes()
                    .toArray()
                    .filter(x => $(x).hasClass("active"))
                    .map(x => $(x).find("a").attr("id"))
                    .join("¤");
            $.post("/api/delete_executions", {identifiers: identifiers}, _ => location.reload());
        });
        $('#executions_table_reschedule_button').dropdown({
            apiSettings: {
                action: 'get profiles',
                onResponse: function (response) {
                    var values = {
                        "success": true,
                        "results": [],
                    };
                    for (v in response) {
                        values["results"].push({
                            "name": response[v],
                            "value": response[v],
                            "text": response[v]
                        });
                    }
                    return values;
                },
            },
            onChange: function (value, text, $selectedItem) {
                $("#executions_table_reschedule_button").addClass("loading");
                let identifiers = $("#executions_table").DataTable()
                        .rows({"search": "applied",})
                        .nodes()
                        .toArray()
                        .filter(x => $(x).hasClass("active"))
                        .map(x => $(x).find("a").attr("id"))
                        .join("¤");
                var profile = $("#executions_table_reschedule_button").find("span").text();
                $.post("/api/reschedule_executions", {
                    identifiers: identifiers,
                    profile: profile
                }, _ => location.reload());
            },
            filterRemoteData: true,
            saveRemoteData: false,
        });


    </script>
</div>